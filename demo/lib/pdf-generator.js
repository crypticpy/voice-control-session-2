/**
 * PDF generator for the Policy Plain Language Converter.
 * Uses pdfmake with default Roboto fonts to produce a working PDF
 * containing all three audience sections plus metadata.
 */

import PdfPrinter from "pdfmake";

/**
 * Helper: maps risk level to a display color hex string for PDF.
 */
function getRiskColor(level) {
  const colors = {
    Critical: "#E8604C",
    High: "#E8604C",
    Medium: "#F2A900",
    Low: "#78BE20",
  };
  return colors[level] || "#666666";
}

/**
 * Generates a PDF document buffer from the structured conversion data.
 * @param {object} data - The complete policy conversion result with all four sections
 * @returns {Promise<Buffer>} PDF as a Buffer
 */
export function generatePDF(data) {
  return new Promise((resolve, reject) => {
    try {
      const { executiveSummary, staffBriefing, publicVersion, metadata } = data;

      const printer = new PdfPrinter({
        Roboto: {
          normal: "Helvetica",
          bold: "Helvetica-Bold",
          italics: "Helvetica-Oblique",
          bolditalics: "Helvetica-BoldOblique",
        },
      });

      const docDefinition = {
        pageSize: "LETTER",
        pageMargins: [50, 60, 50, 60],

        footer: function (currentPage, pageCount) {
          return {
            columns: [
              {
                text: "City of Austin | Austin Public Health",
                alignment: "left",
                fontSize: 8,
                color: "#666666",
                margin: [50, 0, 0, 0],
              },
              {
                text: "Policy Plain Language Converter",
                alignment: "center",
                fontSize: 8,
                color: "#666666",
              },
              {
                text: `Page ${currentPage} of ${pageCount}`,
                alignment: "right",
                fontSize: 8,
                color: "#666666",
                margin: [0, 0, 50, 0],
              },
            ],
            margin: [0, 20, 0, 0],
          };
        },

        content: [
          // ── Title Page ──
          { text: "\n\n\n\n\n", fontSize: 12 },
          {
            text: "Policy Plain Language Converter",
            fontSize: 26,
            bold: true,
            color: "#003054",
            alignment: "center",
          },
          {
            text: "Austin Public Health",
            fontSize: 16,
            color: "#007B83",
            alignment: "center",
            margin: [0, 8, 0, 0],
          },
          {
            text: "\n\n",
            fontSize: 12,
          },
          {
            canvas: [
              {
                type: "line",
                x1: 150,
                y1: 0,
                x2: 362,
                y2: 0,
                lineWidth: 2,
                lineColor: "#007B83",
              },
            ],
          },
          {
            text: "\n",
            fontSize: 12,
          },
          {
            text: metadata.policyTitle || "Policy Analysis Report",
            fontSize: 18,
            bold: true,
            color: "#333333",
            alignment: "center",
            margin: [0, 16, 0, 8],
          },
          {
            text: `Category: ${metadata.policyCategory || "Not specified"}`,
            fontSize: 11,
            color: "#666666",
            alignment: "center",
          },
          {
            text: `Effective Date: ${metadata.effectiveDate || "Not specified"}`,
            fontSize: 11,
            color: "#666666",
            alignment: "center",
            margin: [0, 4, 0, 0],
          },
          {
            text: `Confidence: ${metadata.confidence || "Not specified"}  |  Source Word Count: ${metadata.sourceWordCount || "N/A"}`,
            fontSize: 11,
            color: "#666666",
            alignment: "center",
            margin: [0, 4, 0, 0],
          },
          {
            text: `Document Type: ${metadata.inputQuality || "Not specified"}`,
            fontSize: 11,
            color: "#666666",
            alignment: "center",
            margin: [0, 4, 0, 0],
          },
          {
            text: "\n\nThis report was generated by the Policy Plain Language Converter, an AI-assisted tool. This tool assists with — but does not replace — human review.",
            fontSize: 9,
            color: "#999999",
            alignment: "center",
            italics: true,
            margin: [40, 40, 40, 0],
          },
          {
            text: `Generated: ${new Date().toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })}`,
            fontSize: 9,
            color: "#999999",
            alignment: "center",
            margin: [0, 8, 0, 0],
          },

          // ── Page Break: Executive Summary ──
          { text: "", pageBreak: "after" },

          // Section 1: Executive Summary
          {
            text: "EXECUTIVE SUMMARY",
            fontSize: 18,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            canvas: [
              {
                type: "line",
                x1: 0,
                y1: 0,
                x2: 512,
                y2: 0,
                lineWidth: 2,
                lineColor: "#003054",
              },
            ],
          },
          {
            text: executiveSummary.title || "",
            fontSize: 14,
            bold: true,
            color: "#333333",
            margin: [0, 12, 0, 8],
          },

          // Risk Level badge
          {
            columns: [
              { text: "Risk Level: ", fontSize: 11, bold: true, width: 80 },
              {
                text: ` ${executiveSummary.riskLevel || "N/A"} `,
                fontSize: 11,
                bold: true,
                color:
                  executiveSummary.riskLevel === "Medium"
                    ? "#333333"
                    : "#FFFFFF",
                background: getRiskColor(executiveSummary.riskLevel),
              },
            ],
            margin: [0, 0, 0, 12],
          },

          // Bottom Line
          {
            text: "Bottom Line",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            text:
              executiveSummary.bottomLine || "Not specified in source document",
            fontSize: 11,
            color: "#333333",
            margin: [0, 0, 0, 12],
            italics: true,
          },

          // Summary
          {
            text: "Summary",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            text:
              executiveSummary.summary || "Not specified in source document",
            fontSize: 10,
            color: "#333333",
            margin: [0, 0, 0, 12],
            lineHeight: 1.4,
          },

          // Key Points
          {
            text: "Key Points",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          ...(executiveSummary.keyPoints || []).map((point, i) => ({
            text: `${i + 1}. ${point}`,
            fontSize: 10,
            color: "#333333",
            margin: [10, 0, 0, 4],
            lineHeight: 1.3,
          })),

          // Fiscal Impact
          {
            text: "Fiscal Impact",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 8, 0, 4],
          },
          {
            text:
              executiveSummary.fiscalImpact ||
              "Not specified in source document",
            fontSize: 10,
            color: "#333333",
            margin: [0, 0, 0, 8],
          },

          // Recommendation
          {
            text: "Recommendation",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 4, 0, 4],
          },
          {
            text:
              executiveSummary.recommendation ||
              "Not specified in source document",
            fontSize: 10,
            color: "#333333",
            margin: [0, 0, 0, 12],
            bold: true,
          },

          // ── Page Break: Staff Briefing ──
          { text: "", pageBreak: "after" },

          // Section 2: Staff Briefing
          {
            text: "STAFF BRIEFING",
            fontSize: 18,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            canvas: [
              {
                type: "line",
                x1: 0,
                y1: 0,
                x2: 512,
                y2: 0,
                lineWidth: 2,
                lineColor: "#003054",
              },
            ],
          },
          {
            text: staffBriefing.title || "",
            fontSize: 14,
            bold: true,
            color: "#333333",
            margin: [0, 12, 0, 8],
          },

          // Overview
          {
            text: "Overview",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            text: staffBriefing.overview || "Not specified in source document",
            fontSize: 10,
            color: "#333333",
            margin: [0, 0, 0, 12],
            lineHeight: 1.4,
          },

          // Key Changes Table
          {
            text: "Key Changes",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 8],
          },
          {
            table: {
              headerRows: 1,
              widths: ["20%", "20%", "20%", "*"],
              body: [
                [
                  {
                    text: "Area",
                    bold: true,
                    fontSize: 9,
                    color: "#FFFFFF",
                    fillColor: "#003054",
                  },
                  {
                    text: "Current State",
                    bold: true,
                    fontSize: 9,
                    color: "#FFFFFF",
                    fillColor: "#003054",
                  },
                  {
                    text: "New State",
                    bold: true,
                    fontSize: 9,
                    color: "#FFFFFF",
                    fillColor: "#003054",
                  },
                  {
                    text: "Action Required",
                    bold: true,
                    fontSize: 9,
                    color: "#FFFFFF",
                    fillColor: "#003054",
                  },
                ],
                ...(staffBriefing.keyChanges || []).map((change, i) => [
                  {
                    text: change.area || "",
                    fontSize: 9,
                    fillColor: i % 2 === 0 ? "#F5F5F5" : "#FFFFFF",
                  },
                  {
                    text: change.currentState || "",
                    fontSize: 9,
                    fillColor: i % 2 === 0 ? "#F5F5F5" : "#FFFFFF",
                  },
                  {
                    text: change.newState || "",
                    fontSize: 9,
                    fillColor: i % 2 === 0 ? "#F5F5F5" : "#FFFFFF",
                  },
                  {
                    text: change.actionRequired || "",
                    fontSize: 9,
                    fillColor: i % 2 === 0 ? "#F5F5F5" : "#FFFFFF",
                  },
                ]),
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
              hLineColor: () => "#E8E8E8",
              vLineColor: () => "#E8E8E8",
            },
            margin: [0, 0, 0, 12],
          },

          // Implementation Steps
          {
            text: "Implementation Steps",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 4, 0, 4],
          },
          ...(staffBriefing.implementationSteps || []).map((step, i) => ({
            text: `${i + 1}. ${step}`,
            fontSize: 10,
            color: "#333333",
            margin: [10, 0, 0, 4],
            lineHeight: 1.3,
          })),

          // Timeline
          {
            text: "Timeline",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 8, 0, 4],
          },
          {
            text: staffBriefing.timeline || "Not specified in source document",
            fontSize: 10,
            color: "#333333",
            margin: [0, 0, 0, 8],
          },

          // Affected Teams
          {
            text: "Affected Teams",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 4, 0, 4],
          },
          {
            text:
              (staffBriefing.affectedTeams || []).join(", ") ||
              "Not specified in source document",
            fontSize: 10,
            color: "#333333",
            margin: [0, 0, 0, 12],
          },

          // ── Page Break: Public Version ──
          { text: "", pageBreak: "after" },

          // Section 3: Public Version
          {
            text: "WHAT THIS MEANS FOR YOU",
            fontSize: 18,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 2],
          },
          {
            text: "(Public Version)",
            fontSize: 11,
            color: "#666666",
            margin: [0, 0, 0, 4],
          },
          {
            canvas: [
              {
                type: "line",
                x1: 0,
                y1: 0,
                x2: 512,
                y2: 0,
                lineWidth: 2,
                lineColor: "#003054",
              },
            ],
          },
          {
            text: publicVersion.title || "",
            fontSize: 14,
            bold: true,
            color: "#333333",
            margin: [0, 12, 0, 8],
          },

          // What Is This
          {
            text: "What Is This?",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            text:
              publicVersion.whatIsThis || "Not specified in source document",
            fontSize: 11,
            color: "#333333",
            margin: [0, 0, 0, 12],
            lineHeight: 1.4,
          },

          // Why It Matters
          {
            text: "Why It Matters",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          {
            text:
              publicVersion.whyItMatters || "Not specified in source document",
            fontSize: 11,
            color: "#333333",
            margin: [0, 0, 0, 12],
            lineHeight: 1.4,
          },

          // Key Takeaways
          {
            text: "Key Takeaways",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 0, 0, 4],
          },
          ...(publicVersion.keyTakeaways || []).map((item) => ({
            text: `- ${item}`,
            fontSize: 11,
            color: "#333333",
            margin: [10, 0, 0, 4],
            lineHeight: 1.3,
          })),

          // What You Can Do
          {
            text: "\nWhat You Can Do",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 4, 0, 4],
          },
          ...(publicVersion.whatYouCanDo || []).map((item) => ({
            text: `- ${item}`,
            fontSize: 11,
            color: "#333333",
            margin: [10, 0, 0, 4],
            lineHeight: 1.3,
          })),

          // Where To Get Help
          {
            text: "\nWhere To Get Help",
            fontSize: 12,
            bold: true,
            color: "#003054",
            margin: [0, 4, 0, 4],
          },
          {
            text:
              publicVersion.whereToGetHelp || "Call 311 for more information.",
            fontSize: 11,
            color: "#333333",
            margin: [0, 0, 0, 12],
            lineHeight: 1.4,
          },
        ],

        defaultStyle: {
          font: "Roboto",
        },
      };

      const pdfDoc = printer.createPdfKitDocument(docDefinition);
      const chunks = [];

      pdfDoc.on("data", (chunk) => {
        chunks.push(chunk);
      });

      pdfDoc.on("end", () => {
        resolve(Buffer.concat(chunks));
      });

      pdfDoc.on("error", (err) => {
        reject(err);
      });

      pdfDoc.end();
    } catch (err) {
      reject(err);
    }
  });
}
